<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDI Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Styles for filter area - can be moved to style.css */
        .filter-controls { background-color: var(--bg-secondary); padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border-color); display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .filter-controls > div { display: flex; flex-direction: column; }
        .filter-controls label { margin-bottom: 4px; font-size: 0.85em; color: var(--text-secondary); }
        .filter-controls input[type="text"], .filter-controls select { padding: 8px 10px; width: auto; min-width: 150px; font-size: 0.9em; }
        .filter-controls button { padding: 8px 15px; font-size: 0.9em; margin-bottom: 0; align-self: flex-end; }

        /* Styles for Sort Controls */
        .sort-controls { background-color: var(--bg-secondary); padding: 10px 15px; margin-bottom: 20px; border-radius: 8px; border: 1px solid var(--border-color); display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .sort-controls label { font-size: 0.9em; color: var(--text-secondary); margin-right: 5px;}
        .sort-controls select { padding: 8px 10px; font-size: 0.9em; }
        .sort-controls .direction-toggle button { padding: 8px 12px; font-size: 0.9em; background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); cursor:pointer; }
        .sort-controls .direction-toggle button.active { background-color: var(--mtg-gold-accent); color: var(--bg-primary); border-color: var(--mtg-gold-accent); }


        #enterSaleTab .search-input-container input[type="text"] { min-width: 250px; font-size: 1em; }
        #enterSaleTab .search-input-container label { margin-bottom: 6px; font-size: 1em; }
        .info-box { background-color: var(--bg-tertiary); padding: 10px 15px; margin-bottom: 15px; border-radius: 4px; border: 1px solid var(--border-color); }
        .info-box p { margin:0; color: var(--text-secondary); line-height: 1.4; }
        .info-box strong { color: var(--text-primary); }

        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: var(--bg-secondary); margin: 5% auto; padding: 25px; border: 1px solid var(--border-color); border-radius: 8px; width: 90%; max-width: 800px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); color: var(--text-primary); position: relative; }
        .modal-close-button { color: var(--text-secondary); float: right; font-size: 32px; font-weight: bold; line-height: 1; }
        .modal-close-button:hover, .modal-close-button:focus { color: var(--text-primary); text-decoration: none; cursor: pointer; }
        #setSymbolSearchInput { width: calc(100% - 24px); padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); background-color: var(--bg-tertiary); color: var(--text-primary); border-radius: 4px; }
        .set-symbol-list { max-height: 450px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; padding-right: 10px; }
        .set-symbol-item { display: flex; align-items: center; padding: 10px; border: 1px solid var(--bg-tertiary); border-radius: 6px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .set-symbol-item:hover { background-color: var(--bg-tertiary); border-color: var(--mtg-gold-accent); }
        .set-symbol-item img { width: 32px;  height: 32px; margin-right: 12px; filter: brightness(0) invert(1); object-fit: contain; }
        .set-symbol-item .set-details { font-size: 0.95em; display: flex; flex-direction: column; }
        .set-symbol-item .set-name { display: block; font-weight: bold; color: var(--text-primary); }
        .set-symbol-item .set-code { font-size: 0.9em; color: var(--text-secondary); }
        
        /* Style for the historical monthly summary table */
        .monthly-summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px; /* Add space before the detailed sales table */
            font-size: 0.95em;
        }
        .monthly-summary-table th, .monthly-summary-table td {
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            text-align: left;
        }
        .monthly-summary-table th {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: bold;
        }
        .monthly-summary-table tr:nth-child(even) {
            background-color: var(--bg-secondary);
        }
        .monthly-summary-table tr:hover {
            background-color: #383740;
        }
    </style>
</head>
<body>
    <h1>CDI Card Tracker</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %} <ul class="flashes"> {% for category, message in messages %} <li class="{{ category }}">{{ message }}</li> {% endfor %} </ul> {% endif %}
    {% endwith %}

    <div class="tab-nav">
        <button id="addCardTabNav" class="tab-button" onclick="openTab(event, 'addCardTab')">Add Single Card</button>
        <button id="addSealedProductTabNav" class="tab-button" onclick="openTab(event, 'addSealedProductTab')">Add Sealed Product</button>
        <button id="enterSaleTabNav" class="tab-button" onclick="openTab(event, 'enterSaleTab')">Enter Sale</button>
        <button id="inventoryTabNav" class="tab-button" onclick="openTab(event, 'inventoryTab')">View Inventory</button>
        <button id="salesHistoryTabNav" class="tab-button" onclick="openTab(event, 'salesHistoryTab')">View Sales History</button>
        <button id="importCsvTabNav" class="tab-button" onclick="openTab(event, 'importCsvTab')">Import CSV</button>
    </div>

    <div id="addCardTab" class="tab-content">
        <h2>Add Single Card to Inventory</h2>
        {% if from_pack_details and suggested_buy_price is not none %}
        <div class="info-box">
            <p>Opened <strong>{{ from_pack_details.qty_opened }} x {{ from_pack_details.name }}</strong> (Cost: {{ from_pack_details.cost | currency_commas }}).<br>
                Suggested avg. buy price for singles: <strong>{{ suggested_buy_price | currency_commas }}</strong>.
            </p>
        </div>
        {% endif %}
        <form action="{{ url_for('add_card_route') }}" method="post" class="card-form">
            <div class="form-grid">
                <div>
                    <label for="set_code_add">Set Code (e.g., LEA, MH2):</label>
                    <div style="display:flex; gap: 5px;">
                        <input type="text" id="set_code_add" name="set_code" style="flex-grow:1;">
                        <button type="button" id="findSetBySymbolBtn" class="refresh-button" style="padding: 8px 12px; font-size:0.9em;">Find Symbol</button>
                    </div>
                </div>
                <div><label for="card_name_add">Card Name:</label><input type="text" id="card_name_add" name="card_name"></div>
                <div><label for="collector_number_add">Collector Number:</label><input type="text" id="collector_number_add" name="collector_number"></div>
                <div>
                    <label for="rarity_add">Rarity:</label>
                    <input type="text" id="rarity_add" name="rarity" placeholder="e.g., common, mythic">
                </div>
                <div>
                    <label for="language_add">Language:</label>
                    <select id="language_add" name="language">
                        <option value="en" selected>English (en)</option>
                        <option value="es">Spanish (es)</option>
                        <option value="fr">French (fr)</option>
                        <option value="de">German (de)</option>
                        <option value="it">Italian (it)</option>
                        <option value="pt">Portuguese (pt)</option>
                        <option value="ja">Japanese (ja)</option>
                        <option value="ko">Korean (ko)</option>
                        <option value="ru">Russian (ru)</option>
                        <option value="zhs">Simplified Chinese (zhs)</option>
                        <option value="zht">Traditional Chinese (zht)</option>
                        <option value="ph">Phyrexian (ph)</option>
                        <option value="">Other (Specify if lookup fails)</option>
                    </select>
                </div>
                <div><label for="quantity_add">Quantity:</label><input type="number" id="quantity_add" name="quantity" min="1" value="1" required></div>
                <div>
                    <label for="buy_price_add">Buy Price (each):</label>
                    <input type="number" id="buy_price_add" name="buy_price" value="{{ '%.2f'|format(suggested_buy_price) if suggested_buy_price is not none else '' }}" step="0.01" min="0" required placeholder="$0.00">
                </div>
                <div><label for="asking_price_add">Asking Price (each, opt.):</label><input type="number" id="asking_price_add" name="asking_price" step="0.01" min="0" placeholder="$0.00"></div>
                <div><label for="location_add">Location:</label><input type="text" id="location_add" name="location" required></div>
            </div>
            <div><input type="checkbox" id="is_foil_add" name="is_foil" value="true" style="margin-top:10px;"><label for="is_foil_add">Foil</label></div>
            <button type="submit" style="margin-top:10px;">Add Card to Inventory</button>
        </form>
        <p style="font-size: 0.9em; color: var(--text-secondary); margin-top: 10px;"><em>Lookup: (Set & CN), (Set & Name), (Name & CN), or (Name only). Qty, Buy Price, Location required. Rarity/Language will be auto-filled by Scryfall if found, or use your input.</em></p>
    </div>

    <div id="addSealedProductTab" class="tab-content">
         <h2>Add Sealed Product to Inventory</h2>
         <form action="{{ url_for('add_sealed_product_route') }}" method="post" class="card-form">
            <div class="form-grid">
                <div><label for="product_name_sealed">Product Name:</label><input type="text" id="product_name_sealed" name="product_name" required placeholder="e.g., MOM Draft Pack"></div>
                <div><label for="set_name_sealed">Set Name:</label><input type="text" id="set_name_sealed" name="set_name" required placeholder="e.g., March of the Machine"></div>
                <div><label for="product_type_sealed">Product Type:</label><select id="product_type_sealed" name="product_type" required><option value="">-- Select --</option><option>Draft Booster Pack</option><option>Set Booster Pack</option><option>Collector Booster Pack</option><option>Play Booster Pack</option><option>Draft Booster Box</option><option>Set Booster Box</option><option>Collector Booster Box</option><option>Play Booster Box</option><option>Bundle / Fat Pack</option><option>Precon Deck</option><option>Dual Deck Set</option><option>Secret Lair</option><option value="Other">Other</option></select></div>
                <div>
                    <label for="language_sealed">Language:</label>
                    <select id="language_sealed" name="language">
                        <option value="en" selected>English (en)</option>
                        <option value="es">Spanish (es)</option>
                        <option value="fr">French (fr)</option>
                        <option value="de">German (de)</option>
                        <option value="it">Italian (it)</option>
                        <option value="pt">Portuguese (pt)</option>
                        <option value="ja">Japanese (ja)</option>
                        <option value="ko">Korean (ko)</option>
                        <option value="ru">Russian (ru)</option>
                        <option value="zhs">Simplified Chinese (zhs)</option>
                        <option value="zht">Traditional Chinese (zht)</option>
                    </select>
                </div>
                <div><label for="quantity_sealed">Quantity:</label><input type="number" id="quantity_sealed" name="quantity" min="1" required></div>
                <div><label for="buy_price_sealed">Buy Price (ea):</label><input type="number" id="buy_price_sealed" name="buy_price" step="0.01" min="0" required placeholder="$0.00"></div>
                <div><label for="manual_market_price_sealed">Market Price (ea, opt.):</label><input type="number" id="manual_market_price_sealed" name="manual_market_price" step="0.01" min="0" placeholder="$0.00"></div>
                <div><label for="asking_price_sealed">Asking Price (ea, opt.):</label><input type="number" id="asking_price_sealed" name="asking_price" step="0.01" min="0" placeholder="$0.00"></div>
                <div><label for="location_sealed">Location:</label><input type="text" id="location_sealed" name="location" required></div>
                <div><label for="image_uri_sealed">Image URL (opt.):</label><input type="text" id="image_uri_sealed" name="image_uri" placeholder="http://..."></div>
            </div>
            <div><input type="checkbox" id="is_collectors_item_sealed" name="is_collectors_item" value="true" style="margin-top:10px;"><label for="is_collectors_item_sealed">Collector's Version?</label></div>
            <button type="submit" style="margin-top:10px;">Add Sealed Product</button>
        </form>
    </div>

    <div id="enterSaleTab" class="tab-content">
        <h2>Record a New Sale</h2>
         <form action="{{ url_for('record_sale_route') }}" method="post" class="card-form">
            <div class="search-input-container">
                <label for="cardSearchInput">Search Inventory Item:</label>
                <input type="text" id="cardSearchInput" placeholder="Type name, set, location..." autocomplete="off">
                <input type="hidden" name="inventory_card_id" id="selectedInventoryCardId" required>
                <div id="cardSearchResults" class="search-results-dropdown"></div>
            </div>
            <div class="form-grid" style="margin-top:10px;">
                <div><label for="quantity_sold">Quantity Sold:</label><input type="number" id="quantity_sold" name="quantity_sold" min="1" required></div>
                <div><label for="sell_price_per_item">Sell Price (per item):</label><input type="number" id="sell_price_per_item" name="sell_price_per_item" step="0.01" min="0" required placeholder="$0.00"></div>
                <div><label for="sale_date">Sale Date:</label><input type="date" id="sale_date" name="sale_date" value="{{ current_date }}" required></div>
                <div><label for="shipping_cost">Shipping Cost:</label><select id="shipping_cost" name="shipping_cost" required><option value="0.25">$0.25</option><option value="0.80" selected>$0.80</option><option value="4.39">$4.39</option></select></div>
            </div>
             <div style="margin-top:10px;"><label for="sale_notes">Sale Notes (Optional):</label><input type="text" id="sale_notes" name="sale_notes" placeholder="e.g., Sold on eBay, buyer name" style="width:100%;"></div>
            <button type="submit" style="margin-top:15px;">Record Sale</button>
        </form>
    </div>

    <div id="inventoryTab" class="tab-content">
        <h2>Current Inventory & Sales Summary</h2>
        <p>
            <strong>Total Inventory Buy Cost:</strong> <span id="totalInventoryBuyCost">{{ total_buy_cost_of_inventory | currency_commas }}</span><br>
            <strong>Total Inventory Market Value:</strong> <span id="totalInventoryMarketValue">{{ total_inventory_market_value | currency_commas }}</span><br>
            <strong>Overall Realized P/L (All Time):</strong>
            <span class="{{ 'profit' if overall_realized_pl >= 0 else 'loss' }}">{{ overall_realized_pl | currency_commas }}</span><br>
            <br> 
            <strong>{{ current_month_name }} P/L (Current Month):</strong>
            <span class="{{ 'profit' if current_month_profit_loss >= 0 else 'loss' }}">{{ current_month_profit_loss | currency_commas }}</span><br>
            <strong>Total Sales Transactions ({{ current_month_name }}):</strong> {{ current_month_sales_count }}<br>
            <strong>Total Single Cards Sold (Units, {{ current_month_name }}):</strong> {{ current_month_single_cards_sold_quantity }}<br>
            <strong>Total Sealed Products Sold (Units, {{ current_month_name }}):</strong> {{ current_month_sealed_sold_quantity }}
        </p>
        <div class="filter-controls">
             <div><label for="inventoryFilterInput">Text Search:</label><input type="text" id="inventoryFilterInput" placeholder="Name, Set, Loc, CN, Rarity, Lang..."></div>
             <div><label for="inventoryTypeFilter">Item Type:</label><select id="inventoryTypeFilter"><option value="all" selected>All Types</option><option value="single_card">Single Cards</option><option value="sealed_product">Sealed Products</option></select></div>
             <div><label for="inventoryLocationFilter">Location:</label><select id="inventoryLocationFilter"><option value="all" selected>All Locations</option></select></div>
             <div><label for="inventorySetFilter">Set:</label><select id="inventorySetFilter"><option value="all" selected>All Sets</option></select></div>
             <div><label for="inventoryFoilFilter">Foil (Cards):</label><select id="inventoryFoilFilter"><option value="all" selected>Any</option><option value="yes">Foil Only</option><option value="no">Non-Foil Only</option></select></div>
             <div><label for="inventoryRarityFilter">Rarity (Cards):</label><select id="inventoryRarityFilter"><option value="all" selected>All Rarities</option></select></div>
             <div><label for="inventoryLanguageFilter">Language (Cards):</label><select id="inventoryLanguageFilter"><option value="all" selected>All Languages</option></select></div>
             <div><label for="inventoryCollectorFilter">Collector's (Sealed):</label><select id="inventoryCollectorFilter"><option value="all" selected>Any</option><option value="yes">Collector's Only</option><option value="no">Non-Collector's Only</option></select></div>
             <div><label for="inventorySealedLanguageFilter">Language (Sealed):</label><select id="inventorySealedLanguageFilter"><option value="all" selected>All Languages</option></select></div>
             <div><label>&nbsp;</label><button onclick="clearInventoryFiltersAndSort()">Clear Filters & Sort</button></div>
        </div>
        <div class="sort-controls">
            <label for="inventorySortKey">Sort by:</label>
            <select id="inventorySortKey">
                <option value="display_name" selected>Name</option>
                <option value="set_name_sort">Set</option>
                <option value="location">Location</option>
                <option value="quantity">Quantity</option>
                <option value="buy_price">Buy Price</option>
                <option value="current_market_price">Market Price</option>
                <option value="rarity">Rarity (Cards)</option>
                <option value="language">Language</option>
                <option value="collector_number">Collector # (Cards)</option>
                <option value="product_type">Product Type (Sealed)</option>
            </select>
            <label for="inventorySortDirection" style="margin-left:10px;">Direction:</label>
            <div class="direction-toggle">
                <button id="sortAscBtn" class="active" data-direction="asc">Ascending &#x25B2;</button>
                <button id="sortDescBtn" data-direction="desc">Descending &#x25BC;</button>
            </div>
        </div>
        <div class="card-grid" id="inventoryGrid">
            {# Inventory items will be rendered here by JavaScript #}
        </div>
        <p id="noInventoryResults" style="display: none; color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">No inventory items match the current filters.</p>
    </div>

    <div id="importCsvTab" class="tab-content">
        <h2>Import Collection from CSV (TCGPlayer Format)</h2>
        <form action="{{ url_for('import_csv_route') }}" method="post" enctype="multipart/form-data" class="card-form">
            <p style="font-size: 0.9em; color: var(--text-secondary);">
                Upload a CSV file. The importer expects columns: 'Quantity', 'Name', 'Set', 'Card Number', 'Set Code', 'Printing', 'Rarity', 'Language'.
                Other fields will use defaults you provide below. Language should be a 2-letter code (e.g., en, ja).
            </p>
            <div>
                <label for="csv_file">CSV File:</label>
                <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
            </div>
            <div class="form-grid" style="margin-top: 15px;">
                <div>
                    <label for="default_buy_price_csv">Default Buy Price (if not in CSV):</label>
                    <input type="number" id="default_buy_price_csv" name="default_buy_price" step="0.01" min="0" value="0.00" required placeholder="$0.00">
                </div>
                <div>
                    <label for="default_location_csv">Default Location:</label>
                    <input type="text" id="default_location_csv" name="default_location" required value="Imported Batch">
                </div>
                 <div>
                    <label for="default_asking_price_csv">Default Asking Price (optional):</label>
                    <input type="number" id="default_asking_price_csv" name="default_asking_price" step="0.01" min="0" placeholder="$0.00 (optional)">
                </div>
                <div>
                    <label for="default_language_csv">Default Language (if not in CSV):</label>
                    <select id="default_language_csv" name="default_language_csv">
                        <option value="en" selected>English (en)</option>
                        <option value="es">Spanish (es)</option>
                        <option value="fr">French (fr)</option>
                        <option value="de">German (de)</option>
                        <option value="it">Italian (it)</option>
                        <option value="pt">Portuguese (pt)</option>
                        <option value="ja">Japanese (ja)</option>
                        <option value="ko">Korean (ko)</option>
                        <option value="ru">Russian (ru)</option>
                        <option value="zhs">Simplified Chinese (zhs)</option>
                        <option value="zht">Traditional Chinese (zht)</option>
                        <option value="ph">Phyrexian (ph)</option>
                    </select>
                </div>
            </div>
            <div style="margin-top:15px;">
                <input type="checkbox" id="assume_non_foil_csv" name="assume_non_foil" value="true" checked>
                <label for="assume_non_foil_csv">Assume Non-Foil (if 'Printing' is 'Normal' or foil info missing)</label>
            </div>
            <button type="submit" style="margin-top:20px;">Import Cards from CSV</button>
        </form>
    </div>


    <div id="salesHistoryTab" class="tab-content">
        <h2>Sales History</h2>

        {% if historical_monthly_sales_summary %}
        <h3>Monthly Sales Summaries</h3>
        <table class="monthly-summary-table">
            <thead>
                <tr>
                    <th>Month</th>
                    <th>Total P/L</th>
                    <th>Sales Transactions</th>
                    <th>Single Cards Sold (Units)</th>
                    <th>Sealed Products Sold (Units)</th>
                </tr>
            </thead>
            <tbody>
                {% for summary in historical_monthly_sales_summary %}
                <tr>
                    <td>{{ summary.month_name }}</td>
                    <td><span class="{{ 'profit' if summary.profit_loss >= 0 else 'loss' }}">{{ summary.profit_loss | currency_commas }}</span></td>
                    <td>{{ summary.sales_count }}</td>
                    <td>{{ summary.single_cards_sold }}</td>
                    <td>{{ summary.sealed_products_sold }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        <h3>All Individual Sales</h3>
        <table style="width:100%; border-collapse: collapse;">
            <thead><tr><th>Sale Date</th><th>Item Name</th><th>Details</th><th>Qty Sold</th><th>Buy Price (ea)</th><th>Sell Price (ea)</th><th>Shipping Cost</th><th>Net P/L for Sale</th><th>Notes</th></tr></thead>
            <tbody id="salesHistoryTableBody">
                {# Sales history will be populated by JavaScript #}
            </tbody>
        </table>
        <p id="noSalesResults" style="display: none;">No sales recorded yet. Record sales using the 'Enter Sale' tab.</p>
    </div>

    <div id="setSymbolModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" onclick="closeSetSymbolModal()">&times;</span>
            <h2>Find Set by Symbol</h2>
            <input type="text" id="setSymbolSearchInput" placeholder="Search by set name or code...">
            <div id="setSymbolListContainer" class="set-symbol-list">
                <p>Loading set symbols...</p>
            </div>
        </div>
    </div>

    <script type="application/json" id="inventory_items_json_data">{{ inventory_items_json | safe }}</script>
    <script type="application/json" id="sales_history_json_data">{{ sales_history_json | safe }}</script>
    <script type="application/json" id="sale_inventory_options_json_data">{{ sale_inventory_options_json | safe }}</script>

    <script>
        // Main application JavaScript

        // Helper functions to safely get properties from an object
        function getStr(obj, key, defaultVal = '') {
            // Ensures that if a key exists, its value is returned as a string.
            // If the key doesn't exist or its value is null/undefined, returns the defaultVal.
            if (obj && typeof obj === 'object' && obj !== null && obj[key] !== null && obj[key] !== undefined) {
                return String(obj[key]);
            }
            return defaultVal;
        }
        function getNum(obj, key, defaultVal = null) {
            // Attempts to parse a value from an object as a float.
            // Returns the number if successful, otherwise the defaultVal.
            if (obj && typeof obj === 'object' && obj !== null && obj[key] !== null && obj[key] !== undefined) {
                const num = parseFloat(obj[key]);
                if (!isNaN(num)) return num;
            }
            return defaultVal;
        }
        function getBool(obj, key, defaultVal = false) {
            // Returns a boolean value from an object.
            // If the key exists and its value is strictly a boolean, returns that value.
            // Otherwise, returns the defaultVal.
            if (obj && typeof obj === 'object' && obj !== null && typeof obj[key] === 'boolean') return obj[key];
            return defaultVal;
        }

        // Formats a numeric value as currency (e.g., $1,234.56 or -$50.00)
        function formatCurrencyJS(value) {
            const numValue = parseFloat(value); 
            if (value === null || value === undefined || isNaN(numValue)) return "$0.00"; // Default for invalid inputs
            try {
                // Uses toLocaleString for proper formatting including commas and two decimal places.
                if (numValue < 0) return `-$${Math.abs(numValue).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                return `$${numValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            } catch (e) { 
                // Fallback if toLocaleString fails (should be rare)
                return String(value); 
            }
        }

        // Global variables to store data fetched from the server
        let rawInventoryItemsData = [];
        let rawSalesHistoryData = []; // For the detailed sales log
        let saleInventoryOptionsData = []; // For the "Enter Sale" search dropdown

        // Safely parse JSON data embedded in the HTML
        try {
            const invJsonEl = document.getElementById('inventory_items_json_data');
            const invJson = invJsonEl ? invJsonEl.textContent : '[]';
            rawInventoryItemsData = JSON.parse(invJson);
            if (!Array.isArray(rawInventoryItemsData)) rawInventoryItemsData = []; // Ensure it's an array
        } catch (e) {
            console.error("Error parsing inventory_items_json:", e, document.getElementById('inventory_items_json_data')?.textContent);
            rawInventoryItemsData = []; // Default to empty array on error
        }
        try {
            const salesJsonEl = document.getElementById('sales_history_json_data');
            const salesJson = salesJsonEl ? salesJsonEl.textContent : '[]';
            rawSalesHistoryData = JSON.parse(salesJson);
            if (!Array.isArray(rawSalesHistoryData)) rawSalesHistoryData = [];
        } catch (e) {
            console.error("Error parsing sales_history_json:", e, document.getElementById('sales_history_json_data')?.textContent);
            rawSalesHistoryData = [];
        }
        try {
            const saleOptsJsonEl = document.getElementById('sale_inventory_options_json_data');
            const saleOptsJson = saleOptsJsonEl ? saleOptsJsonEl.textContent : '[]';
            saleInventoryOptionsData = JSON.parse(saleOptsJson);
            if (!Array.isArray(saleInventoryOptionsData)) saleInventoryOptionsData = [];
        } catch (e) {
            console.error("Error parsing sale_inventory_options_json:", e, document.getElementById('sale_inventory_options_json_data')?.textContent);
            saleInventoryOptionsData = [];
        }

        let allScryfallSets = []; // To store set data for the "Find Set by Symbol" modal

        // Function to switch between tabs
        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; } // Hide all tab content
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) { tabbuttons[i].className = tabbuttons[i].className.replace(" active", ""); } // Deactivate all tab buttons
            
            var currentTab = document.getElementById(tabName);
            if (currentTab) { currentTab.style.display = "block"; } // Display the selected tab content
            
            // Activate the clicked tab button
            var activeBtnId = tabName + "Nav"; 
            var activeBtn = document.getElementById(activeBtnId);
            if (evt && evt.currentTarget) { 
                evt.currentTarget.className += " active"; 
            } else if (activeBtn) { // For programmatic tab opening (e.g., on page load)
                activeBtn.className += " active"; 
            }
        }
        // Get the active tab from Flask (if specified in URL, otherwise default to inventoryTab)
        var activeTabFromFlask = "{{ active_tab|default('inventoryTab') }}";

        // DOM elements for inventory filtering and display
        const inventoryFilterInput = document.getElementById('inventoryFilterInput');
        const inventoryTypeFilter = document.getElementById('inventoryTypeFilter');
        const inventoryLocationFilter = document.getElementById('inventoryLocationFilter');
        const inventorySetFilter = document.getElementById('inventorySetFilter');
        const inventoryFoilFilter = document.getElementById('inventoryFoilFilter');
        const inventoryRarityFilter = document.getElementById('inventoryRarityFilter');
        const inventoryLanguageFilter = document.getElementById('inventoryLanguageFilter');
        const inventoryCollectorFilter = document.getElementById('inventoryCollectorFilter');
        const inventorySealedLanguageFilter = document.getElementById('inventorySealedLanguageFilter');
        const inventoryGrid = document.getElementById('inventoryGrid');
        const noInventoryResultsMsg = document.getElementById('noInventoryResults');

        // DOM elements for inventory sorting
        const inventorySortKeySelect = document.getElementById('inventorySortKey');
        const sortAscBtn = document.getElementById('sortAscBtn');
        const sortDescBtn = document.getElementById('sortDescBtn');
        let currentSortDirection = 'asc'; // Default sort direction

        // Populates a select dropdown with unique values from a data list
        function populateDropdown(selectElement, dataList, property, itemTypeFilter = null) {
            if (!selectElement || !dataList || !Array.isArray(dataList)) {
                console.warn("populateDropdown: Invalid arguments or dataList not an array.", {selectElement, dataList});
                return;
            }
            try {
                let sourceData = dataList;
                // Optionally filter data by item type before extracting unique values
                if (itemTypeFilter) {
                    sourceData = dataList.filter(item => item && getStr(item, 'type') === itemTypeFilter);
                }
                // Get unique, non-empty string values for the specified property, then sort them
                const uniqueValues = [...new Set(
                    sourceData.map(item => item && item[property] !== undefined && item[property] !== null ? String(item[property]) : null)
                              .filter(value => value !== null && value.trim() !== '')
                )].sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

                const currentValue = selectElement.value; // Preserve current selection if possible
                selectElement.innerHTML = '<option value="all" selected>All</option>'; // Default "All" option
                uniqueValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    const text = String(value);
                    option.textContent = text.charAt(0).toUpperCase() + text.slice(1); // Capitalize first letter
                    selectElement.appendChild(option);
                });
                // Restore previous selection if it's still valid
                if (uniqueValues.includes(String(currentValue))) {
                    selectElement.value = currentValue;
                } else {
                     selectElement.value = 'all'; // Default to "All" if previous selection is no longer valid
                }
            } catch(e) { console.error("Error in populateDropdown for property:", property, e); }
        }

        // Renders the inventory items based on current filters and sort order
        function renderInventory() {
            if (!inventoryGrid) { console.error("inventoryGrid not found for renderInventory"); return; }
            try {
                // Get current filter values
                const filterText = inventoryFilterInput ? inventoryFilterInput.value.toLowerCase() : '';
                const filterType = inventoryTypeFilter ? inventoryTypeFilter.value : 'all';
                const filterLocation = inventoryLocationFilter ? inventoryLocationFilter.value : 'all';
                const filterSet = inventorySetFilter ? inventorySetFilter.value : 'all';
                const filterFoil = inventoryFoilFilter ? inventoryFoilFilter.value : 'all';
                const filterRarity = inventoryRarityFilter ? inventoryRarityFilter.value : 'all';
                const filterCardLanguage = inventoryLanguageFilter ? inventoryLanguageFilter.value : 'all';
                const filterCollector = inventoryCollectorFilter ? inventoryCollectorFilter.value : 'all';
                const filterSealedLanguage = inventorySealedLanguageFilter ? inventorySealedLanguageFilter.value : 'all';
                const sortKey = inventorySortKeySelect ? inventorySortKeySelect.value : 'display_name';

                // Filter items from raw data
                let filteredItems = (rawInventoryItemsData || []).filter(item => {
                    if (!item) return false;
                    let show = true;
                    // Apply type filter
                    if (filterType !== 'all' && getStr(item, 'type') !== filterType) { show = false; }
                    // Apply location filter
                    if (show && filterLocation !== 'all' && getStr(item, 'location') !== filterLocation) { show = false; }
                    // Apply set filter (handles both set_code for cards and set_name for sealed)
                    const itemSetIdentifier = getStr(item, 'type') === 'single_card' ? (getStr(item, 'set_code') || getStr(item, 'set_name')) : getStr(item, 'set_name');
                    if (show && filterSet !== 'all' && String(itemSetIdentifier) !== String(filterSet)) { show = false; }
                    
                    // Type-specific filters
                    if (getStr(item, 'type') === 'single_card') {
                        if (show && filterFoil !== 'all' && (getBool(item, 'is_foil') ? 'yes' : 'no') !== filterFoil) { show = false; }
                        if (show && filterRarity !== 'all' && getStr(item, 'rarity') !== filterRarity) { show = false; }
                        if (show && filterCardLanguage !== 'all' && getStr(item, 'language') !== filterCardLanguage) { show = false; }
                    } else if (getStr(item, 'type') === 'sealed_product') {
                        if (show && filterCollector !== 'all' && (getBool(item, 'is_collectors_item') ? 'yes' : 'no') !== filterCollector) { show = false; }
                        if (show && filterSealedLanguage !== 'all' && getStr(item, 'language') !== filterSealedLanguage) { show = false; }
                    }
                    // Apply text search filter across multiple fields
                    if (show && filterText !== '') {
                        const searchText = filterText.toLowerCase();
                        if (! ( (getStr(item, 'display_name')).toLowerCase().includes(searchText) ||
                                (getStr(item, 'set_code')).toLowerCase().includes(searchText) ||
                                (getStr(item, 'set_name')).toLowerCase().includes(searchText) ||
                                (getStr(item, 'location')).toLowerCase().includes(searchText) ||
                                (item.type === 'single_card' && (getStr(item, 'collector_number')).toLowerCase().includes(searchText)) ||
                                (item.type === 'single_card' && (getStr(item, 'rarity')).toLowerCase().includes(searchText)) ||
                                (getStr(item, 'language')).toLowerCase().includes(searchText) ||
                                (item.type === 'sealed_product' && (getStr(item, 'product_type')).toLowerCase().includes(searchText))
                             )) { show = false; }
                    }
                    return show;
                });

                // Sort filtered items
                filteredItems.sort((a, b) => {
                    let valA, valB;
                    if (!a || !b) return 0; 

                    // Special handling for sorting by set (uses set_code or set_name)
                    if (sortKey === 'set_name_sort') { 
                        valA = getStr(a, 'type') === 'single_card' ? (getStr(a, 'set_code') || getStr(a, 'set_name')) : getStr(a, 'set_name');
                        valB = getStr(b, 'type') === 'single_card' ? (getStr(b, 'set_code') || getStr(b, 'set_name')) : getStr(b, 'set_name');
                    } else {
                        valA = a[sortKey]; 
                        valB = b[sortKey];
                    }

                    // Handle null/undefined values by pushing them to the end
                    const valAIsNull = valA === null || valA === undefined;
                    const valBIsNull = valB === null || valB === undefined;
                    if (valAIsNull && valBIsNull) return 0;
                    if (valAIsNull) return currentSortDirection === 'asc' ? 1 : -1; 
                    if (valBIsNull) return currentSortDirection === 'asc' ? -1 : 1; 

                    // Normalize values for comparison (lowercase for strings)
                    const typeA = typeof valA; const typeB = typeof valB;
                    if (typeA === 'string' && typeB === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                    else if (typeA === 'number' && typeB === 'number') { /* No change needed */ }
                    else if (typeA === 'boolean' && typeB === 'boolean') { /* No change needed */ }
                    else { valA = String(valA).toLowerCase(); valB = String(valB).toLowerCase(); } // Fallback to string comparison

                    let comparison = 0;
                    if (valA > valB) comparison = 1;
                    else if (valA < valB) comparison = -1;
                    return currentSortDirection === 'asc' ? comparison : comparison * -1; // Apply sort direction
                });

                inventoryGrid.innerHTML = ''; // Clear previous inventory display
                if (noInventoryResultsMsg) noInventoryResultsMsg.style.display = filteredItems.length === 0 ? 'block' : 'none'; // Show/hide "no results" message

                // Create and append HTML for each filtered item
                filteredItems.forEach(item => {
                    if (!item) return; 
                    const cardEntry = document.createElement('div');
                    cardEntry.className = 'card-entry';
                    
                    // Extract common item properties
                    const displayName = getStr(item, 'display_name', 'N/A');
                    const imageUri = getStr(item, 'image_uri');
                    const location = getStr(item, 'location', 'N/A');
                    const quantity = getNum(item, 'quantity', 0);
                    const buyPrice = getNum(item, 'buy_price');
                    const marketPrice = getNum(item, 'current_market_price');
                    const sellPrice = getNum(item, 'sell_price'); // This is the asking price
                    const originalId = item.original_id; 

                    let itemHTML = `
                        ${imageUri ? `<img src="${imageUri}" alt="${displayName}" class="card-image">` : '<div class="card-image-placeholder">No Image</div>'}
                        <h3>${displayName}</h3>
                        <p>`;
                    
                    if (item.type === 'single_card') {
                        const setCode = getStr(item, 'set_code', 'N/A');
                        const collectorNum = getStr(item, 'collector_number', 'N/A');
                        const rarity = getStr(item, 'rarity', 'N/A');
                        const language = getStr(item, 'language', 'N/A');
                        const isFoil = getBool(item, 'is_foil');
                        
                        // Get pre-calculated display values from the item object (passed from app.py)
                        const marketVsBuyPercentageDisplay = getStr(item, 'market_vs_buy_percentage_display', 'N/A');
                        const potentialPLAtAskingPriceDisplay = item.potential_pl_at_asking_price_display; // Can be number or string

                        
                        let marketVsBuyPercentageHTML = 'N/A'; // Default

                        if (marketVsBuyPercentageDisplay === "Infinite") {
                            marketVsBuyPercentageHTML = `<span class="profit">Infinite%</span>`;
                        } else if (marketVsBuyPercentageDisplay === "N/A") {
                            marketVsBuyPercentageHTML = 'N/A';
                        } else {
                            // Try to parse as a number if it's not "Infinite" or "N/A"
                            const numericVal = parseFloat(marketVsBuyPercentageDisplay);
                            if (!isNaN(numericVal)) { // Check if parsing was successful
                                const className = numericVal >= 0 ? 'profit' : 'loss';
                                marketVsBuyPercentageHTML = `<span class="${className}">${numericVal.toFixed(2)}%</span>`;
                            } else {
                                // If it's not "Infinite", "N/A", or a valid number string, display the original string
                                marketVsBuyPercentageHTML = marketVsBuyPercentageDisplay; 
                            }
                        }

                        let potentialPLHTML = 'N/A (No asking price)';
                        if (typeof potentialPLAtAskingPriceDisplay === 'number') {
                            const className = potentialPLAtAskingPriceDisplay >= 0 ? 'profit' : 'loss';
                            potentialPLHTML = `<span class="${className}">${formatCurrencyJS(potentialPLAtAskingPriceDisplay)}</span>`;
                        } else { // Should be "N/A (No asking price)" string
                            potentialPLHTML = potentialPLAtAskingPriceDisplay;
                        }

                        itemHTML += `
                            <strong>Set:</strong> ${setCode.toUpperCase()}-${collectorNum} ${isFoil ? '(Foil)' : ''}<br>
                            <strong>Rarity:</strong> ${rarity ? rarity.charAt(0).toUpperCase() + rarity.slice(1) : 'N/A'}<br>
                            <strong>Language:</strong> ${language ? language.toUpperCase() : 'N/A'}<br>
                            <strong>Location:</strong> ${location}<br>
                            <strong>Quantity:</strong> ${quantity}<br>
                            <strong>Buy Price (ea):</strong> ${formatCurrencyJS(buyPrice)}<br>
                            <strong>Market Price (ea):</strong> ${marketPrice !== null ? formatCurrencyJS(marketPrice) : 'N/A'}<br>
                            <strong>Asking Price (ea):</strong> ${sellPrice !== null ? formatCurrencyJS(sellPrice) : 'Not Set'}<br>
                            <strong>Market vs. Buy %:</strong> ${marketVsBuyPercentageHTML}<br>
                            <strong>Potential P/L (Asking):</strong> ${potentialPLHTML}<br>
                        `;
                    } else if (item.type === 'sealed_product') {
                        const setName = getStr(item, 'set_name', 'N/A');
                        const productType = getStr(item, 'product_type', 'N/A');
                        const language = getStr(item, 'language', 'N/A');
                        // Ensure isCollectorsItem is declared and retrieved correctly for sealed_product
                        const isCollectorsItem = getBool(item, 'is_collectors_item'); 
                        
                        const marketVsBuyDisplay = getStr(item, 'market_vs_buy_percentage_display', "N/A (Manual Price)");
                        const potentialPLDisplay = item.potential_pl_at_asking_price_display;

                        let potentialPLSealedHTML = 'N/A (No asking price)';
                        if (typeof potentialPLDisplay === 'number') {
                             const className = potentialPLDisplay >= 0 ? 'profit' : 'loss';
                             potentialPLSealedHTML = `<span class="${className}">${formatCurrencyJS(potentialPLDisplay)}</span>`;
                        } else {
                            potentialPLSealedHTML = potentialPLDisplay;
                        }
                        itemHTML += `
                            <strong>Set:</strong> ${setName}<br>
                            <strong>Type:</strong> ${productType} ${isCollectorsItem ? '<span style="font-style: italic;">(Collector\'s Item)</span>' : ''}<br>
                            <strong>Language:</strong> ${language ? language.toUpperCase() : 'N/A'}<br>
                            <strong>Location:</strong> ${location}<br>
                            <strong>Quantity:</strong> ${quantity}<br>
                            <strong>Buy Price (ea):</strong> ${formatCurrencyJS(buyPrice)}<br>
                            <strong>Market Price (ea):</strong> ${marketPrice !== null ? formatCurrencyJS(marketPrice) + ' <em style="font-size:0.9em;">(Manual)</em>' : 'N/A'}<br>
                            <strong>Asking Price (ea):</strong> ${sellPrice !== null ? formatCurrencyJS(sellPrice) : 'Not Set'}<br>
                            <strong>Market vs. Buy %:</strong> ${marketVsBuyDisplay}<br>
                            <strong>Potential P/L (Asking):</strong> ${potentialPLSealedHTML}<br>
                        `;
                    }
                    itemHTML += `</p>`; // Close the paragraph for item details

                    // Add action buttons and update forms
                    if (item.type === 'single_card') {
                        const displayNameEscaped = displayName.replace(/"/g, '&quot;'); // Escape quotes for JS confirm
                        itemHTML += `
                        <div class="actions">
                            <form action="/delete_card/${originalId}" method="post" style="display:inline;"><button type="submit" class="delete-button" onclick="return confirm('Delete Card Entry (ID: ${originalId}) for ${displayNameEscaped}?');">Delete</button></form>
                            <form action="/refresh_card/${originalId}" method="post" style="display:inline;"><button type="submit" class="refresh-button">Refresh Market Data</button></form>
                        </div>
                        <details class="update-details"><summary>Update Card Details</summary>
                            <form action="/update_card/${originalId}" method="post" class="update-form">
                                <div><label>Qty:</label><input type="number" name="quantity" value="${quantity}" min="0"></div>
                                <div><label>Buy Price:</label><input type="number" name="buy_price" value="${buyPrice !== null ? buyPrice.toFixed(2) : ''}" step="0.01" min="0" placeholder="$0.00"></div>
                                <div><label>Asking Price:</label><input type="number" name="asking_price" value="${sellPrice !== null ? sellPrice.toFixed(2) : ''}" placeholder="Blank to clear" step="0.01" min="0"></div>
                                <div><label>Location:</label><input type="text" name="location" value="${location}" required></div>
                                <button type="submit">Save Card</button>
                            </form>
                        </details>`;
                    } else if (item.type === 'sealed_product') {
                        const displayNameEscaped = displayName.replace(/"/g, '&quot;');
                        const buyPriceValue = buyPrice !== null ? buyPrice : ''; // Ensure a value for hidden input
                        // Re-ensure isCollectorsItem is in scope if used again, or re-fetch if necessary
                        // For this structure, it's already defined above for sealed products
                        const isCollectorsItem = getBool(item, 'is_collectors_item'); // This re-declaration is technically redundant if structured perfectly, but safe.

                        itemHTML += `
                        <div class="actions">
                            <form action="/delete_sealed_product/${originalId}" method="post" style="display:inline;"><button type="submit" class="delete-button" onclick="return confirm('Delete Sealed Product Entry (ID: ${originalId}) for ${displayNameEscaped}?');">Delete</button></form>
                            <form action="/initiate_open_sealed/${originalId}" method="post" class="open-product-form" style="display:inline-block; margin-left:5px; vertical-align: top;"><div style="display:flex; align-items:center; gap:5px;"><input type="number" name="quantity_to_open" value="1" min="1" max="${quantity}" required style="width: 50px; padding: 7px;"><input type="hidden" name="original_product_name" value="${displayNameEscaped}"><input type="hidden" name="original_buy_price" value="${buyPriceValue}"><button type="submit" class="refresh-button" style="padding:8px 12px; font-size:0.9em;">Open</button></div></form>
                        </div>
                        <details class="update-details"><summary>Update Sealed Details</summary>
                            <form action="/update_sealed_product/${originalId}" method="post" class="update-form">
                                <div><label>Qty:</label><input type="number" name="quantity" value="${quantity}" min="0"></div>
                                <div><label>Buy Price:</label><input type="number" name="buy_price" value="${buyPrice !== null ? buyPrice.toFixed(2) : ''}" step="0.01" min="0" placeholder="$0.00"></div>
                                <div><label>Market Price:</label><input type="number" name="manual_market_price" value="${marketPrice !== null ? marketPrice.toFixed(2) : ''}" placeholder="Blank to clear" step="0.01" min="0"></div>
                                <div><label>Asking Price:</label><input type="number" name="asking_price" value="${sellPrice !== null ? sellPrice.toFixed(2) : ''}" placeholder="Blank to clear" step="0.01" min="0"></div>
                                <div><label>Location:</label><input type="text" name="location" value="${location}" required></div>
                                <div><label>Image URL:</label><input type="text" name="image_uri" value="${imageUri || ''}" placeholder="http://... Blank to clear"></div>
                                <div><label for="update_language_sealed_${originalId}">Language:</label>
                                    <select id="update_language_sealed_${originalId}" name="language">
                                        <option value="en" ${getStr(item, 'language') === 'en' ? 'selected' : ''}>English (en)</option>
                                        <option value="es" ${getStr(item, 'language') === 'es' ? 'selected' : ''}>Spanish (es)</option>
                                        <option value="fr" ${getStr(item, 'language') === 'fr' ? 'selected' : ''}>French (fr)</option>
                                        <option value="de" ${getStr(item, 'language') === 'de' ? 'selected' : ''}>German (de)</option>
                                        <option value="it" ${getStr(item, 'language') === 'it' ? 'selected' : ''}>Italian (it)</option>
                                        <option value="pt" ${getStr(item, 'language') === 'pt' ? 'selected' : ''}>Portuguese (pt)</option>
                                        <option value="ja" ${getStr(item, 'language') === 'ja' ? 'selected' : ''}>Japanese (ja)</option>
                                        <option value="ko" ${getStr(item, 'language') === 'ko' ? 'selected' : ''}>Korean (ko)</option>
                                        <option value="ru" ${getStr(item, 'language') === 'ru' ? 'selected' : ''}>Russian (ru)</option>
                                        <option value="zhs" ${getStr(item, 'language') === 'zhs' ? 'selected' : ''}>Simplified Chinese (zhs)</option>
                                        <option value="zht" ${getStr(item, 'language') === 'zht' ? 'selected' : ''}>Traditional Chinese (zht)</option>
                                    </select>
                                </div>
                                <div><input type="checkbox" id="update_is_collectors_item_sealed_${originalId}" name="is_collectors_item" value="true" ${isCollectorsItem ? 'checked' : ''}><label for="update_is_collectors_item_sealed_${originalId}">Collector's Item?</label></div>
                                <button type="submit">Save Sealed</button>
                            </form>
                        </details>`;
                }
                cardEntry.innerHTML = itemHTML;
                inventoryGrid.appendChild(cardEntry);
            });
            } catch (e) {
                console.error("Error in renderInventory:", e);
                if (inventoryGrid) inventoryGrid.innerHTML = "<p style='color:red;'>Error rendering inventory. Check browser console for details.</p>";
            }
        }

        // Renders the detailed sales history table
        function renderSalesHistory() {
            const tableBody = document.getElementById('salesHistoryTableBody');
            const noSalesMsg = document.getElementById('noSalesResults');
            if (!tableBody || !noSalesMsg) { console.error("Sales history table elements not found"); return; }
            try {
                tableBody.innerHTML = ''; // Clear previous sales
                // Show/hide the "no sales" message and the monthly summary section based on whether any sales data exists
                const hasSales = rawSalesHistoryData && rawSalesHistoryData.length > 0;
                noSalesMsg.style.display = hasSales ? 'none' : 'block';
                
                const monthlySummaryTable = document.querySelector('.monthly-summary-table');
                const monthlySummaryHeading = document.querySelector('#salesHistoryTab > h3'); // Assumes h3 is for monthly summary
                
                if (monthlySummaryTable) monthlySummaryTable.style.display = hasSales ? '' : 'none'; // Or 'table'
                if (monthlySummaryHeading) monthlySummaryHeading.style.display = hasSales ? '' : 'none';


                if (hasSales) {
                    rawSalesHistoryData.forEach(sale => {
                        if(!sale) return;
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = getStr(sale, 'sale_date', 'N/A');
                        row.insertCell().textContent = getStr(sale, 'original_item_name', 'N/A');
                        row.insertCell().textContent = getStr(sale, 'original_item_details', 'N/A');
                        row.insertCell().textContent = getNum(sale, 'quantity_sold', 0);
                        row.insertCell().innerHTML = formatCurrencyJS(getNum(sale, 'buy_price_per_item'));
                        row.insertCell().innerHTML = formatCurrencyJS(getNum(sale, 'sell_price_per_item'));
                        row.insertCell().innerHTML = formatCurrencyJS(getNum(sale, 'shipping_cost'));
                        const profitLossCell = row.insertCell();
                        const profitLoss = getNum(sale, 'profit_loss');
                        profitLossCell.innerHTML = `<span class="${(typeof profitLoss === 'number' && profitLoss >= 0) ? 'profit' : 'loss'}">${formatCurrencyJS(profitLoss)}</span>`;
                        row.insertCell().textContent = getStr(sale, 'notes', '');
                    });
                }
            } catch (e) {
                console.error("Error in renderSalesHistory:", e);
                if (tableBody) tableBody.innerHTML = "<tr><td colspan='9' style='color:red;'>Error rendering sales history. Check browser console.</td></tr>";
            }
        }

        // Clears all inventory filters and resets sort order, then re-renders inventory
        function clearInventoryFiltersAndSort() {
            if (inventoryFilterInput) inventoryFilterInput.value = '';
            if (inventoryTypeFilter) inventoryTypeFilter.value = 'all';
            if (inventoryLocationFilter) inventoryLocationFilter.value = 'all';
            if (inventorySetFilter) inventorySetFilter.value = 'all';
            if (inventoryFoilFilter) inventoryFoilFilter.value = 'all';
            if (inventoryRarityFilter) inventoryRarityFilter.value = 'all';
            if (inventoryLanguageFilter) inventoryLanguageFilter.value = 'all';
            if (inventoryCollectorFilter) inventoryCollectorFilter.value = 'all';
            if (inventorySealedLanguageFilter) inventorySealedLanguageFilter.value = 'all';
            if (inventorySortKeySelect) inventorySortKeySelect.value = 'display_name'; // Default sort key
            currentSortDirection = 'asc'; // Default sort direction
            updateSortDirectionButtons();
            renderInventory();
        }

        // Updates the visual state of sort direction buttons (Ascending/Descending)
        function updateSortDirectionButtons() {
            if (sortAscBtn && sortDescBtn) {
                if (currentSortDirection === 'asc') {
                    sortAscBtn.classList.add('active');
                    sortDescBtn.classList.remove('active');
                } else {
                    sortDescBtn.classList.add('active');
                    sortAscBtn.classList.remove('active');
                }
            }
        }

        // --- "Enter Sale" Tab: Inventory Search Functionality ---
        const cardSearchInputEl = document.getElementById('cardSearchInput');
        const cardSearchResultsDivEl = document.getElementById('cardSearchResults');
        const selectedInventoryCardIdInputEl = document.getElementById('selectedInventoryCardId');

        if (cardSearchInputEl && cardSearchResultsDivEl && selectedInventoryCardIdInputEl) {
             cardSearchInputEl.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                cardSearchResultsDivEl.innerHTML = ''; // Clear previous results
                selectedInventoryCardIdInputEl.value = ''; // Clear hidden input
                if (searchTerm.length < 1) { // Don't search if input is empty
                    cardSearchResultsDivEl.style.display = 'none'; 
                    return; 
                }
                // Filter inventory options based on search term
                const matchedItems = (saleInventoryOptionsData || []).filter(item => item && (item.display || '').toLowerCase().includes(searchTerm));
                
                if (matchedItems.length > 0) {
                    cardSearchResultsDivEl.style.display = 'block'; // Show dropdown
                    matchedItems.slice(0, 15).forEach(item => { // Limit to 15 results
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('search-result-item');
                        itemDiv.textContent = item.display; 
                        itemDiv.dataset.itemId = item.id; // Store item ID
                        itemDiv.addEventListener('click', function() {
                            selectedInventoryCardIdInputEl.value = this.dataset.itemId; // Set hidden input
                            cardSearchInputEl.value = this.textContent; // Set search bar text
                            cardSearchResultsDivEl.innerHTML = ''; // Clear results
                            cardSearchResultsDivEl.style.display = 'none'; // Hide dropdown
                        });
                        cardSearchResultsDivEl.appendChild(itemDiv);
                    });
                } else { 
                    cardSearchResultsDivEl.style.display = 'none'; // Hide if no matches
                }
            });
            // Hide search results dropdown if clicked outside
            document.addEventListener('click', function(event) {
                if (cardSearchInputEl && cardSearchResultsDivEl) {
                     if (!cardSearchInputEl.contains(event.target) && !cardSearchResultsDivEl.contains(event.target)) {
                        cardSearchResultsDivEl.style.display = 'none';
                    }
                }
            });
        }

        // --- "Find Set by Symbol" Modal Functionality ---
        const setSymbolModal = document.getElementById("setSymbolModal");
        const findSetBySymbolBtn = document.getElementById("findSetBySymbolBtn");
        const setSymbolListContainer = document.getElementById("setSymbolListContainer");
        const setCodeAddInput = document.getElementById("set_code_add"); // Input field to populate
        const setSymbolSearchInput = document.getElementById("setSymbolSearchInput"); // Search within modal

        // Fetches all set data from Scryfall API (if not already fetched) and renders symbols
        async function fetchAndDisplaySetSymbols() { 
            if (allScryfallSets.length > 0) { // Use cached data if available
                renderSetSymbols(allScryfallSets); 
                return; 
            } 
            setSymbolListContainer.innerHTML = "<p>Loading set symbols...</p>"; 
            try { 
                const response = await fetch("{{ url_for('api_all_sets_info') }}"); 
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); } 
                allScryfallSets = await response.json(); 
                if(!Array.isArray(allScryfallSets)) allScryfallSets = []; // Ensure it's an array
                renderSetSymbols(allScryfallSets); 
            } catch (error) { 
                console.error("Could not fetch set symbols:", error); 
                setSymbolListContainer.innerHTML = "<p>Error loading set symbols. Please try again later.</p>"; 
            } 
        }
        // Renders the list of set symbols in the modal
        function renderSetSymbols(setsToRender) { 
            setSymbolListContainer.innerHTML = ""; 
            if (!setsToRender || setsToRender.length === 0) { 
                setSymbolListContainer.innerHTML = "<p>No sets found matching your search.</p>"; 
                return; 
            } 
            setsToRender.forEach(set => { 
                if (set && set.icon_svg_uri) { // Only display if an icon URI exists
                    const itemDiv = document.createElement("div"); 
                    itemDiv.className = "set-symbol-item"; 
                    itemDiv.onclick = function() { selectSetSymbol(set.code); }; // Set click action
                    
                    const img = document.createElement("img"); 
                    img.src = set.icon_svg_uri; 
                    img.alt = (getStr(set, 'name', 'Set')) + " symbol"; 
                    
                    const detailsDiv = document.createElement("div"); 
                    detailsDiv.className = "set-details"; 
                    const nameSpan = document.createElement("span"); 
                    nameSpan.className = "set-name"; 
                    nameSpan.textContent = getStr(set, 'name', 'N/A'); 
                    const codeSpan = document.createElement("span"); 
                    codeSpan.className = "set-code"; 
                    codeSpan.textContent = `(${(getStr(set, 'code', 'N/A')).toUpperCase()})`; 
                    
                    detailsDiv.appendChild(nameSpan); 
                    detailsDiv.appendChild(codeSpan); 
                    itemDiv.appendChild(img); 
                    itemDiv.appendChild(detailsDiv); 
                    setSymbolListContainer.appendChild(itemDiv); 
                } 
            }); 
        }
        // Filters set symbols based on text input in the modal's search bar
        function filterSetSymbols() { 
            if (!setSymbolSearchInput) return; 
            const filterText = setSymbolSearchInput.value.toLowerCase(); 
            const filteredSets = (allScryfallSets || []).filter(set => { 
                return set && ((getStr(set,'name')).toLowerCase().includes(filterText) || (getStr(set,'code')).toLowerCase().includes(filterText)); 
            }); 
            renderSetSymbols(filteredSets); 
        }
        // Action when a set symbol is clicked: populates the set code input and closes modal
        function selectSetSymbol(setCode) { 
            if (setCodeAddInput && setCode) { 
                setCodeAddInput.value = setCode.toUpperCase(); 
            } 
            closeSetSymbolModal(); 
        }
        // Opens the "Find Set by Symbol" modal
        function openSetSymbolModal() { 
            if (setSymbolModal) { 
                setSymbolModal.style.display = "block"; 
                fetchAndDisplaySetSymbols(); // Fetch/render symbols when modal opens
            } 
        }
        // Closes the "Find Set by Symbol" modal
        function closeSetSymbolModal() { 
            if (setSymbolModal) { 
                setSymbolModal.style.display = "none"; 
            } 
        }
        // Event listener for the "Find Symbol" button
        if (findSetBySymbolBtn) { findSetBySymbolBtn.onclick = openSetSymbolModal; }
        // Event listener for the search input within the modal
        if (setSymbolSearchInput) { setSymbolSearchInput.addEventListener('keyup', filterSetSymbols); }

        // Close modal if clicked outside of its content area
         window.onclick = function(event) {
            if (event.target == setSymbolModal) { 
                closeSetSymbolModal(); 
            }
        }

        // --- Main Page Initialization on DOMContentLoaded ---
         document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Content Loaded. Initializing page...");
            try {
                // Open the correct tab based on Flask's context or default
                openTab(null, activeTabFromFlask);
                console.log("Tab opened.");

                // Populate filter dropdowns for the inventory view
                try {
                    console.log("Populating dropdowns...");
                    populateDropdown(inventoryLocationFilter, rawInventoryItemsData, 'location');
                    // Populate set filter with unique set codes/names
                    let uniqueSets = [...new Set((rawInventoryItemsData || []).map(item => item.type === 'single_card' ? (getStr(item, 'set_code') || getStr(item, 'set_name')) : getStr(item, 'set_name')).filter(s => s).sort((a,b) => String(a).toLowerCase().localeCompare(String(b).toLowerCase())))];
                    if (inventorySetFilter) {
                        const currentSetVal = inventorySetFilter.value;
                        inventorySetFilter.innerHTML = '<option value="all" selected>All Sets</option>';
                        uniqueSets.forEach(s => { const option = document.createElement('option'); option.value = s; option.textContent = s; inventorySetFilter.appendChild(option); });
                        if (uniqueSets.includes(currentSetVal)) inventorySetFilter.value = currentSetVal; else inventorySetFilter.value = 'all';
                    }
                    populateDropdown(inventoryRarityFilter, rawInventoryItemsData, 'rarity', 'single_card');
                    populateDropdown(inventoryLanguageFilter, rawInventoryItemsData, 'language', 'single_card');
                    populateDropdown(inventorySealedLanguageFilter, rawInventoryItemsData, 'language', 'sealed_product');
                    console.log("Dropdowns populated.");
                } catch (e) { console.error("Error populating dropdowns:", e); }

                // Attach event listeners to inventory filter and sort controls
                if (inventoryFilterInput) inventoryFilterInput.addEventListener('input', renderInventory);
                if (inventoryTypeFilter) inventoryTypeFilter.addEventListener('change', renderInventory);
                if (inventoryLocationFilter) inventoryLocationFilter.addEventListener('change', renderInventory);
                if (inventorySetFilter) inventorySetFilter.addEventListener('change', renderInventory);
                if (inventoryFoilFilter) inventoryFoilFilter.addEventListener('change', renderInventory);
                if (inventoryRarityFilter) inventoryRarityFilter.addEventListener('change', renderInventory);
                if (inventoryLanguageFilter) inventoryLanguageFilter.addEventListener('change', renderInventory);
                if (inventoryCollectorFilter) inventoryCollectorFilter.addEventListener('change', renderInventory);
                if (inventorySealedLanguageFilter) inventorySealedLanguageFilter.addEventListener('change', renderInventory);

                if (inventorySortKeySelect) inventorySortKeySelect.addEventListener('change', renderInventory);
                if (sortAscBtn) sortAscBtn.addEventListener('click', function() { currentSortDirection = 'asc'; updateSortDirectionButtons(); renderInventory(); });
                if (sortDescBtn) sortDescBtn.addEventListener('click', function() { currentSortDirection = 'desc'; updateSortDirectionButtons(); renderInventory(); });
                console.log("Event listeners attached.");

                // Initial render of dynamic content
                updateSortDirectionButtons();
                console.log("Rendering initial inventory...");
                renderInventory();
                console.log("Rendering sales history...");
                renderSalesHistory(); 
                console.log("Page initialization complete.");

            } catch (e) {
                // Catch-all for critical errors during page setup
                console.error("Critical error during DOMContentLoaded setup:", e);
                const body = document.querySelector('body');
                if (body) { // Display an error message to the user if possible
                    const errorDiv = document.createElement('div');
                    errorDiv.innerHTML = "<h2>Error Loading Page Content</h2><p>A JavaScript error occurred. Please open the browser's developer console (usually F12, then click 'Console') for more details and report the error.</p>";
                    errorDiv.style.color = "red"; errorDiv.style.padding = "20px"; errorDiv.style.textAlign = "center"; errorDiv.style.border = "2px solid red"; errorDiv.style.margin = "20px";
                    const h1 = document.querySelector('h1'); // Try to insert error message after main heading
                    if (h1 && h1.nextSibling) body.insertBefore(errorDiv, h1.nextSibling); else if (body.firstChild) body.insertBefore(errorDiv, body.firstChild); else body.appendChild(errorDiv);
                }
            }
         });
    </script>

</body>
</html>